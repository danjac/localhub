{# Copyright (c) 2019 by Dan Jacob #}
{# SPDX-License-Identifier: AGPL-3.0-or-later #}

{% load i18n %}
{% load activities_tags %}
{% load rules %}

{% with is_content_sensitive=object|is_content_sensitive:user %}
<article role="{{ object_type }}" id="{{ object_type }}-{{ object.id }}" class="card"{% if is_content_sensitive %} data-controller="content-sensitive"{% endif %}>
  {% if is_content_sensitive %}
  <div class="card-header" data-target="content-sensitive.togglable">
    <div class="card-subtitle h6">
      {% include "activities/includes/timesince.html" with timestamp=object.published|default:object.created owner=object.owner %}
    </div>
  </div>
  <div class="card-header d-hide" data-target="content-sensitive.togglable">
    {% else %}
    <div class="card-header">
      {% endif %}

      {% has_perm "communities.moderate_community" user community as can_moderate_community %}
      {% if object.is_flagged and can_moderate_community %}
      <div class="toast text-center">
        <a href="{{ object.get_absolute_url }}">
          {% blocktrans %}This {{ object_type }} has been flagged{% endblocktrans %}
        </a>
      </div>
      {% endif %}

      <div class="card-title activity-title">

        {% if object.is_reshare %}

        <div class="card-subtitle h6">
          {% include "activities/includes/timesince.html" with timestamp=object.published|default:object.created owner=object.owner is_reshare=True %}
        </div>
        <div class="divider"></div>

        {% if object.parent %}
        <a href="{{ object.parent.get_absolute_url }}">{{ object.title|truncatechars:130 }}</a>
        {% endif %}

        {% else %}

        {% block title %}

        {% if is_detail %}
        {{ object.title }}
        {% else %}
        <a href="{{ object.get_absolute_url }}">{{ object.title|truncatechars:130 }}</a>
        {% endif %}

        {% endblock title %}

        {% endif %}

      </div>
      <div class="card-subtitle h6">
        {% if object.parent %}
        {% include "activities/includes/timesince.html" with timestamp=object.parent.published owner=object.parent.owner %}
        {% elif not object.is_reshare %}
        {% include "activities/includes/timesince.html" with timestamp=object.published|default:object.created owner=object.owner %}
        {% endif %}
      </div>
    </div>
    <div class="card-body">
      {% if object.is_reshare and not object.parent %}
      {% blocktrans %}
      The original {{ object_type }} has been removed.
      {% endblocktrans %}
      {% else %}
      {% if object.is_reshare %}<blockquote>{% endif %}
        {% if is_content_sensitive %}
        <div class="empty bg-dark" data-target="content-sensitive.togglable">
          <p class="empty-title h5">{% trans "Sensitive Content" %}</p>
          <p class="empty-subtitle">{% trans "This post has been tagged sensitive. You can view all sensitive content by default in your settings." %}</p>
          <p>
            {% for tag in object.get_content_warning_tags %}
            #{{ tag }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
          </p>
          <div class="empty-action d-hide" data-controller="js-toggle">
            <button class="btn btn-primary" data-action="content-sensitive#toggle">{% trans "Show Content" %}</button>
          </div>
        </div>
        <div class="d-hide" data-target="content-sensitive.togglable">
          {% endif %}
          {% with ignore_collapsable=is_detail|default:is_content_sensitive %}
          {% collapsable ignore_collapsable %}
          {% block content %}{% endblock %}
          {% endcollapsable %}
          {% endwith %}
          {% if is_content_sensitive %}</div>{% endif %}
        {% if object.is_reshare %}</blockquote>{% endif %}
      {% endif %}
    </div>
    <div class="card-footer">
      {% if is_detail %}

      {% if object.edited and object.published and object.edited > object.published %}
        <div class="info">
          {% blocktrans with edited=object.edited|timesince %}Updated {{ edited }} ago{% endblocktrans %}
          {% if object.editor != object.owner %}
          {% trans "by" %}
          {% include "users/includes/chip.html" with profile=object.editor %}
          {% endif %}
        </div>
      {% endif %}

      {% with num_reshares=reshares.count %}
      {% if num_reshares %}
      {% if num_reshares > 20 %}
      {% blocktrans %}
      <b>{{ num_reshares }}</b> people have reshared this post.
      {% endblocktrans %}
      {% else %}
      <div class="info">{% trans "Reshared by" %}
        {% for reshare in reshares %}
        {% include "users/includes/chip.html" with profile=reshare.owner profile_url=reshare.get_absolute_url %}&nbsp;
        {% endfor %}
      </div>
      {% endif %}
      {% endif %}
      {% endwith %}

      {% elif object.num_reshares %}
      <div class="info">
        {{ object.num_reshares }}
        {% blocktrans count counter=object.num_reshares %}
        person has reshared this {{ object_type }}
        {% plural %}
        people have reshared this {{ object_type }}
        {% endblocktrans %}
      </div>
      {% endif %}
      {% if object.num_likes and object.owner == user %}
      <div class="info">
        {{ object.num_likes }}
        {% blocktrans count counter=object.num_likes %}
        person liked this {{ object_type }}
        {% plural %}
        people liked this {{ object_type }}
        {% endblocktrans %}
      </div>
      {% endif %}
      <div class="actions" data-controller="toggle">
        {% if is_detail %}
        <a href="{{ object.get_permalink }}">{% trans "Permalink" %}</a>
        {% else %}
        {% has_perm "activities.create_comment" user object as can_create_comment %}
        {% with num_comments=object.num_comments|default:0 %}
        {% if num_comments or can_create_comment %}
        <a href="{{ object.get_absolute_url }}#comments">
          {% if num_comments %}
          {{ num_comments }}
          {% blocktrans count counter=num_comments %}
          Comment
          {% plural %}
          Comments
          {% endblocktrans %}
          {% else %}
          {% trans "Comment" %}
          {% endif %}
        </a>
        {% else %}
        <a href="{{ object.get_permalink }}">{% trans "Permalink" %}</a>
        {% endif %}
        {% endwith %}
        {% endif %}
        {% if user.is_authenticated %}
        {% block actions %}

        {% has_perm "activities.like_activity" user object as can_like %}
        {% if can_like %}
        <span class="d-hide" data-controller="js-toggle">
          <a href="{{ object.get_like_url }}"
             {% if object.has_liked %} class="d-hide"{% endif %}
                                       data-controller="ajax"
                                       data-target="toggle.togglable"
                                       data-toggle-target="like"
                                       data-ajax-redirect="none"
                                       data-action="ajax#post toggle#toggle"
                                       >{% trans "Like" %}</a>
          <a href="{{ object.get_dislike_url }}"
             {% if not object.has_liked %} class="d-hide"{% endif %}
                                           data-controller="ajax"
                                           data-target="toggle.togglable"
                                           data-toggle-target="like"
                                           data-ajax-redirect="none"
                                           data-action="ajax#post toggle#toggle"
                                           >{% trans "Unlike" %}</a>
        </span>
        {% endif %}

        {% if not object.has_reshared %}
        {% has_perm "activities.reshare_activity" user object as can_reshare %}
        {% if can_reshare %}
        <a class="d-hide"
           data-controller="js-toggle ajax"
           data-action="ajax#post"
           data-ajax-redirect="{{ request.path }}"
           href="{{ object.get_reshare_url }}"
           >{% trans "Reshare" %}</a>
        {% endif %}
        {% endif %}

        {% has_perm "activities.flag_activity" user object as can_flag %}
        {% if can_flag and not object.has_flagged %}
        <a href="{{ object.get_flag_url }}">
          {% trans "Flag" %}
        </a>
        {% endif %}

        {% has_perm "activities.change_activity" user object as can_change %}
        {% if can_change %}
        <a href="{{ object.get_update_url }}">{% trans "Edit" %}</a>
        {% endif %}


        {% has_perm "activities.delete_activity" user object as can_delete %}
        {% if can_delete %}
        <a href="{{ object.get_delete_url }}"
           data-controller="ajax confirm"
           data-action="confirm#check ajax#post"
           data-confirm-header="{% trans 'Delete' %}"
           data-confirm-body="{% trans 'Are you sure you want to delete this item?' %}"
           >{% trans "Delete" %}</a>
        {% endif %}

        {% endblock %}
        {% endif %}
      </div>
    </div>
</article>
{% endwith %}
