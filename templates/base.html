{# Copyright (c) 2019 by Dan Jacob #}
{# SPDX-License-Identifier: AGPL-3.0-or-later #}

{% load static %}
{% load i18n %}
{% load account %}
{% load rules %}
{% load messageboard_tags %}
{% load notifications_tags %}
{% load users_tags %}

{% test_rule "communities.is_member" user community as is_member %}
{% has_perm "communities.view_community" user community as can_view_community %}

<!DOCTYPE html>
<html lang="en">

  <head>
    <title>
      {% block title %}
      {{ community.name }}
      {% block subtitle %}{% endblock %}
      {% endblock %}
    </title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="turbolinks-cache-control" content="no-cache">
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
    <link rel="stylesheet" href="{% static 'dist/main.css' %}">
    <script defer src="{% static 'dist/main.js' %}"></script>
  </head>

  <body class="bg-dark text-dark">
    <div class="container">
      <header class="navbar px-2 py-1 my-2">
        <section class="navbar-section">
          <a class="navbar-brand mr-2 text-light" href="/">
            {{ community.name }}
          </a>
        </section>
        {% block search_form %}
        {% if can_view_community %}
        <section class="navbar-section hide-sm">
          <form method="GET"
                action="{% url 'activities:search' %}"
                data-controller="form"
                data-action="form#submit"
                >
                <div class="input-group input-inline">
                  <input class="form-input" name="q" type="search" placeholder="{% trans "Search" %}">
                  <button class="btn input-group-btn">
                    {% trans "Search" %}
                  </button>
                </div>
          </form>
        </section>
        {% endif %}
        {% endblock search_form %}
        {% block navbar_auth %}
        <section class="navbar-section">
          {% with current_url=request.resolver_match.url_name %}
          {% if user.is_authenticated %}
          <a class="btn btn-link text-light" href="{% if is_member %}{{ user.get_absolute_url }}{% else %}{% url 'user_update' %}{% endif %}">
            {% avatar user %}
            {% user_display user as display_name %}
            {{ display_name }}
          </a>
          <a class="btn btn-link text-light"
             href="{% url 'account_logout' %}"
             data-controller="ajax"
             data-action="ajax#post"
             data-ajax-redirect="/"
             >{% trans "Logout" %}</a>
          {% else %}
          <a class="btn btn-link text-light" href="{% url 'account_login' %}">{% trans "Login" %}</a>
          <a class="btn btn-link text-light" href="{% url 'account_signup' %}">{% trans "Signup" %}</a>
          {% endif %}
          {% endwith %}
        </section>
        {% endblock %}
      </header>
      {% block mobile_search_form %}
      {% if can_view_community %}
      <form method="GET"
            action="{% url 'activities:search' %}"
            class="form-horizontal show-sm mb-2"
            data-controller="form"
            data-action="form#submit"
            >
            <div class="input-group">
              <input class="form-input" name="q" type="search" placeholder="{% trans "Search" %}">
              <button class="btn input-group-btn">
                {% trans "Search" %}
              </button>
            </div>
      </form>
      {% endif %}
      {% endblock mobile_search_form %}

      <div class="columns p-2 bg-light">
        <div class="text-center mb-2 toast toast-primary d-hide" data-controller="cookie-notice" data-cookie-notice-domain="{{ community.domain }}">
          <button class="btn btn-clear float-right" data-action="cookie-notice#accept"></button>
          {% blocktrans %}
          This site uses cookies for authentication purposes only. We do not share your personal
          information with third parties.
          {% endblocktrans %}
        </div>
        {% for message in messages %}
        <div class="text-center my-2 toast toast-{{ message.tags }}" data-controller="alert">
          <button class="btn btn-clear float-right" data-action="alert#dismiss"></button>
          {{ message }}
        </div>
        {% endfor %}
      </div>

      {% block main_layout %}
      <div class="columns bg-light py-2" data-controller="sidebar">

        <div class="column col-3 col-lg-12 hide-lg p-2"
             data-target="sidebar.nav"
             >
             <div class="show-lg hide-xl mb-2">
               <a href="#"
                  class="btn btn-sm btn-link btn-block"
                  data-action="sidebar#toggle"
                  >{% trans "Close Sidebar" %}</a>
             </div>
          {% block sidebar_content %}
          {% include "includes/sidebar.html" %}
          {% endblock %}
        </div>
        <div class="column col-9 col-lg-12 bg-light pt-2" data-target="sidebar.main">
          <div class="show-lg hide-xl float-right mb-2">
            <a href="#"
               class="btn btn-sm btn-link"
               data-action="sidebar#toggle"
               >
               {% block sidebar_toggle %}
               {% get_unread_notification_count user community as unread_notifications %}
               {% get_unread_message_count user community as unread_messages %}
               {% with total_notifications_count=unread_notifications|add:unread_messages %}
               <span{% if total_notifications_count %} class="badge" data-badge="{{ total_notifications_count }}"{% endif %}>
                 {% trans "Sidebar" %}
               </span>
              {% endwith %}
              {% endblock %}
            </a>
          </div>
          <div class="clearfix"></div>
          {% block content %}{% endblock content %}
        </div>
      </div>
      {% endblock main_layout %}
    </div>
    <footer class="text-center p-2 text-light">
      &copy; Dan Jacob {% now "Y" %}. {% blocktrans %}<a href="https://gitlab.com/danjac/localhub/">Open software</a> licensed under <a href="http://www.affero.org/oagpl.html">AGPL</a>{% endblocktrans %}.
    </footer>
    {% include "includes/confirm_dialog.html" %}
  </body>

</html>
