{# Copyright (c) 2019 by Dan Jacob #}
{# SPDX-License-Identifier: AGPL-3.0-or-later #}

{% extends "base.html" %}
{% load i18n %}
{% load account %}
{% load rules %}
{% load users_tags %}

{% block subtitle %} | {% user_display user_obj %}{% endblock %}

{% block content %}

<h3>{% avatar user_obj "avatar-lg" %}{% user_display user_obj %}</h3>
<h4>@{{ user_obj.username }}</h4>

{% if user_obj.bio %}
<p class="py-2">
  {{ user_obj.bio|urlize|linebreaksbr }}
</p>
{% elif is_current_user %}
<p>{% trans "Click the 'My Settings' link to add a bio to your profile." %}</p>
{% endif %}

{% if is_current_user %}
{% blocktrans with created=membership.created|timesince %}
You have been a member for <b>{{ created }}</b>.
{% endblocktrans %}
{% elif membership %}
<p>
  {% if membership.is_admin %}
  {% trans "This user is a community admin." %}
  {% elif membership.is_moderator %}
  {% trans "This user is a community moderator." %}
  {% else %}
  {% trans "This user is a member of this community." %}
  {% endif %}
  {% blocktrans with created=membership.created|timesince %}
  They have been a member for <b>{{ created }}</b>.
  {% endblocktrans %}
</p>
{% endif %}

{% if user.is_authenticated %}

{% has_perm "users.block_user" user user_obj as can_block_user %}
{% has_perm "users.follow_user" user user_obj as can_follow_user %}
{% has_perm "users.change_user" user user_obj as can_change_user %}
{% has_perm "private_messages.create_message" user community as can_create_message %}
{% has_perm "communities.view_membership" user membership as can_view_membership %}

<div class="actions" data-controller="toggle">

  {% if can_change_user %}
  <a href="{% url 'user_update' %}">
    {% trans "My Settings" %}
  </a>
  {% endif %}

  {% if can_follow_user %}
  {% with following=user.following.all %}
  <a href="{% url 'users:unfollow' user_obj.username %}"
     {% if user_obj not in following %}class="d-hide"{% endif %}
     data-controller="ajax"
     data-action="ajax#post toggle#toggle"
     data-target="toggle.togglable"
     data-toggle-target="follow"
     data-ajax-redirect="none">
    {% trans "Unfollow" %}
  </a>
  <a href="{% url 'users:follow' user_obj.username %}"
     {% if user_obj in following %}class="d-hide"{% endif %}
     data-controller="ajax"
     data-action="ajax#post toggle#toggle"
     data-target="toggle.togglable"
     data-toggle-target="follow"
     data-ajax-redirect="none">
    {% trans "Follow" %}
  </a>
  {% endwith %}
  {% endif %}

  {% if can_block_user %}
  {% with blocked=user.blocked.all %}
  <a href="{% url 'users:unblock' user_obj.username %}"
     {% if user_obj not in blocked %}class="d-hide"{% endif %}
     data-controller="ajax"
     data-action="ajax#post toggle#toggle"
     data-target="toggle.togglable"
     data-toggle-target="block"
     data-ajax-redirect="none">
    {% trans "Unblock" %}
  </a>
  <a href="{% url 'users:block' user_obj.username %}"
     {% if user_obj in blocked %}class="d-hide"{% endif %}
     data-controller="ajax"
     data-action="ajax#post toggle#toggle"
     data-target="toggle.togglable"
     data-toggle-target="block"
     data-ajax-redirect="none">
    {% trans "Block" %}
  </a>
  {% endwith %}
  {% endif %}

  {% if not is_current_user %}

  {% if can_create_message %}
  <a href="{% url 'private_messages:message_create' user_obj.username %}">{% trans "Send Message" %}</a>
  {% endif %}

  {% if can_view_membership %}
  <a href="{% url 'communities:membership_detail' membership.id %}">{% trans "Membership" %}</a>
  {% endif %}
  {% endif %}

</div>

{% endif %}

<div class="divider"></div>

<ul class="tab tab-block">
  <li class="tab-item" data-controller="active-link" data-active-link-exact>
    <a data-target="active-link.match"
       href="{% url 'users:activities' user_obj.username %}">{% trans "Posts" %}</a>
  </li>
  <li class="tab-item" data-controller="active-link" data-active-link-exact>
    <a data-target="active-link.match"
       href="{% url 'users:comments' user_obj.username %}">{% trans "Comments" %}</a>
  </li>
  {% if user.is_authenticated and not is_current_user %}
  <li class="tab-item" data-controller="active-link" data-active-link-exact>
    <a data-target="active-link.match"
       href="{% url 'users:messages' user_obj.username %}">{% trans "Messages" %}</a>
  </li>
  {% endif %}
</ul>

{% block user_content %}{% endblock %}
{% endblock content %}
